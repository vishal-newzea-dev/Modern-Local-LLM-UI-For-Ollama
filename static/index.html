<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Local LLM UI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        /* Basic scrollbar styling */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1f2937; }
        ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #6b7280; }

        /* Blinking cursor for AI response streaming */
        .blinking-cursor { display: inline-block; width: 10px; height: 20px; background-color: #f3f4f6; animation: blink 1s step-end infinite; }
        @keyframes blink { from, to { background-color: transparent } 50% { background-color: #f3f4f6; } }

        /* Markdown formatting styles */
        .message-content strong { font-weight: 700; }
        .message-content ul, .message-content ol { margin-left: 1.5rem; margin-top: 0.5rem; margin-bottom: 0.5rem; }
        .message-content li { margin-bottom: 0.25rem; }
        .message-content pre { background-color: #111827; border-radius: 0.5rem; padding: 1rem; overflow-x: auto; color: #d1d5db; margin-top: 0.5rem; margin-bottom: 0.5rem; }
        .message-content code { font-family: 'Courier New', Courier, monospace; background-color: #2c3543; padding: 0.1rem 0.3rem; border-radius: 0.25rem; }
        .message-content pre code { background-color: transparent; padding: 0; }
        .message-content a { color: #60a5fa; text-decoration: underline; }
    </style>
</head>
<body class="bg-gray-900 text-gray-200 font-sans flex h-full">

    <div class="w-1/4 max-w-xs bg-gray-800 p-6 flex flex-col h-full shadow-lg">
        <h1 class="text-2xl font-bold mb-4 text-white">Local LLM Interface</h1>
        <button id="new-chat-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg mb-4 transition duration-300">
            + New Chat
        </button>
        <div class="mb-4">
            <label for="model-select" class="block text-sm font-medium text-gray-400 mb-2">Select Ollama Model</label>
            <select id="model-select" class="w-full bg-gray-700 border border-gray-600 text-white rounded-lg p-2.5 focus:ring-blue-500 focus:border-blue-500"></select>
        </div>
        <div id="chat-history" class="flex-1 overflow-y-auto border-t border-gray-700 pt-4 space-y-1"></div>
        <div class="text-xs text-gray-500 pt-4 border-t border-gray-700">
            <p>Status: <span id="status-light" class="inline-block w-3 h-3 bg-red-500 rounded-full mr-1"></span><span id="status-text">Ready</span></p>
        </div>
    </div>

    <div class="flex-1 flex flex-col h-full">
        <div id="chat-messages" class="flex-1 overflow-y-auto p-6 space-y-6"></div>
        <div class="p-6 bg-gray-900 border-t border-gray-700">
            <div class="bg-gray-800 rounded-lg p-2 flex items-center">
                <textarea id="message-input" placeholder="Type your message here..." class="w-full bg-transparent p-2 text-gray-200 focus:outline-none resize-none" rows="1"></textarea>
                <button id="stop-btn" class="ml-2 bg-red-600 hover:bg-red-700 text-white font-bold p-3 rounded-lg transition duration-300 hidden">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect></svg>
                </button>
                <button id="send-btn" class="ml-2 bg-blue-600 hover:bg-blue-700 text-white font-bold p-3 rounded-lg transition duration-300">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
                </button>
            </div>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const modelSelect = document.getElementById('model-select');
        const chatMessages = document.getElementById('chat-messages');
        const messageInput = document.getElementById('message-input');
        const sendBtn = document.getElementById('send-btn');
        const stopBtn = document.getElementById('stop-btn');
        const statusLight = document.getElementById('status-light');
        const statusText = document.getElementById('status-text');
        const newChatBtn = document.getElementById('new-chat-btn');
        const chatHistoryContainer = document.getElementById('chat-history');

        let conversations = {};
        let activeConversationId = null;
        let abortController = null;

        function loadConversations() {
            const saved = localStorage.getItem('ollama_conversations');
            if (saved) conversations = JSON.parse(saved);
            const savedActiveId = localStorage.getItem('ollama_active_id');
            activeConversationId = savedActiveId && conversations[savedActiveId] ? savedActiveId : null;
        }

        function saveConversations() {
            localStorage.setItem('ollama_conversations', JSON.stringify(conversations));
            if (activeConversationId) localStorage.setItem('ollama_active_id', activeConversationId);
            else localStorage.removeItem('ollama_active_id');
        }

        function startNewChat() {
            activeConversationId = crypto.randomUUID();
            conversations[activeConversationId] = { title: 'New Chat', messages: [] };
            renderUI();
            messageInput.focus();
        }

        function switchConversation(id) {
            activeConversationId = id;
            renderUI();
        }

        function deleteConversation(id) {
            delete conversations[id];
            if (activeConversationId === id) {
                const remainingIds = Object.keys(conversations);
                activeConversationId = remainingIds.length > 0 ? remainingIds[0] : null;
            }
            saveConversations();
            if (!activeConversationId) startNewChat();
            else renderUI();
        }

        function renderUI() {
            renderChatHistory();
            renderChatMessages();
        }

        function renderChatHistory() {
            chatHistoryContainer.innerHTML = '';
            Object.keys(conversations).forEach(id => {
                const convo = conversations[id];
                const historyItem = document.createElement('div');
                historyItem.className = 'flex items-center justify-between group';
                const titleButton = document.createElement('button');
                titleButton.className = `flex-1 text-left p-2 rounded-lg truncate ${id === activeConversationId ? 'bg-gray-700' : 'hover:bg-gray-600'}`;
                titleButton.textContent = convo.title;
                titleButton.onclick = () => switchConversation(id);
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'ml-2 p-1 rounded-md text-gray-500 hover:text-red-400 hover:bg-gray-600 opacity-0 group-hover:opacity-100 transition-opacity';
                deleteBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>`;
                deleteBtn.onclick = (e) => { e.stopPropagation(); deleteConversation(id); };
                historyItem.append(titleButton, deleteBtn);
                chatHistoryContainer.appendChild(historyItem);
            });
        }

        function renderChatMessages() {
            chatMessages.innerHTML = '';
            const activeConvo = conversations[activeConversationId];
            if (!activeConvo || activeConvo.messages.length === 0) {
                chatMessages.innerHTML = `<div class="flex items-start gap-4"><div class="w-8 h-8 rounded-full bg-gradient-to-r from-blue-500 to-purple-600 shrink-0 flex items-center justify-center font-bold text-white">AI</div><div class="bg-gray-800 rounded-lg p-4 max-w-2xl"><p>Hello! Select a model and send a message.</p></div></div>`;
                return;
            }
            activeConvo.messages.forEach(msg => addMessageToUI(msg.role, msg.content));
        }

        async function fetchModels() {
            try {
                const response = await fetch('/api/models');
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const models = await response.json();
                modelSelect.innerHTML = '';
                if (models && models.length > 0) {
                    models.forEach(model => modelSelect.add(new Option(model.name, model.name)));
                    statusLight.classList.replace('bg-red-500', 'bg-green-500');
                    statusText.textContent = `Ready (${models.length} models)`;
                } else {
                    modelSelect.innerHTML = '<option>No models found</option>';
                    statusText.textContent = 'Ollama found, no models';
                }
            } catch (error) {
                modelSelect.innerHTML = '<option>Failed to load</option>';
                statusText.textContent = 'Ollama not detected';
            }
        }

        async function sendMessage() {
            const content = messageInput.value.trim();
            if (!content || !activeConversationId) return;

            const activeConvo = conversations[activeConversationId];
            activeConvo.messages.push({ role: 'user', content: content });
            addMessageToUI('user', content);
            messageInput.value = '';

            if (activeConvo.messages.length === 1) {
                activeConvo.title = content.substring(0, 30) + (content.length > 30 ? '...' : '');
                renderChatHistory();
            }

            const aiMessageContainer = addMessageToUI('assistant', '<span class="blinking-cursor"></span>');
            const aiContentElement = aiMessageContainer.querySelector('div');

            abortController = new AbortController();
            sendBtn.classList.add('hidden');
            stopBtn.classList.remove('hidden');
            messageInput.disabled = true;

            try {
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ model: modelSelect.value, messages: activeConvo.messages }),
                    signal: abortController.signal
                });

                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let fullResponse = '';
                aiContentElement.innerHTML = '';

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    const chunk = decoder.decode(value, { stream: true });
                    const lines = chunk.split('\n');
                    lines.forEach(line => {
                        if (line.startsWith('data: ')) {
                            try {
                                const jsonData = JSON.parse(line.substring(6));
                                if (jsonData.message?.content) {
                                    fullResponse += jsonData.message.content;
                                    aiContentElement.innerHTML = marked.parse(fullResponse);
                                    chatMessages.scrollTop = chatMessages.scrollHeight;
                                }
                            } catch (e) {}
                        }
                    });
                }
                activeConvo.messages.push({ role: 'assistant', content: fullResponse });
                saveConversations();
            } catch (error) {
                if (error.name !== 'AbortError') {
                    aiContentElement.innerHTML = '<span class="text-red-400">Error: Could not get response.</span>';
                } else {
                    const lastMessage = activeConvo.messages[activeConvo.messages.length - 1];
                    if (lastMessage.role !== 'assistant') {
                         activeConvo.messages.push({ role: 'assistant', content: aiContentElement.innerText + ' [stopped]' });
                         saveConversations();
                    }
                }
            } finally {
                sendBtn.classList.remove('hidden');
                stopBtn.classList.add('hidden');
                messageInput.disabled = false;
                messageInput.focus();
                abortController = null;
            }
        }

        function addMessageToUI(role, content) {
            const wrapper = document.createElement('div');
            wrapper.className = 'flex items-start gap-4';
            const icon = role === 'user' ? '<div class="w-8 h-8 rounded-full bg-gray-600 shrink-0 flex items-center justify-center font-bold">You</div>' : '<div class="w-8 h-8 rounded-full bg-gradient-to-r from-blue-500 to-purple-600 shrink-0 flex items-center justify-center font-bold text-white">AI</div>';
            const textClass = role === 'user' ? 'bg-blue-600 text-white' : 'bg-gray-800';
            const escapedContent = content.replace(/</g, "&lt;").replace(/>/g, "&gt;");
            const parsedContent = role === 'user' ? `<p>${escapedContent}</p>` : `<div>${marked.parse(content)}</div>`;
            wrapper.innerHTML = `${icon}<div class="${textClass} rounded-lg p-4 max-w-2xl message-content">${parsedContent}</div>`;
            chatMessages.appendChild(wrapper);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            return wrapper.querySelector('.message-content');
        }

        sendBtn.addEventListener('click', sendMessage);
        messageInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });
        newChatBtn.addEventListener('click', startNewChat);
        
        stopBtn.addEventListener('click', () => {
            if (abortController) {
                abortController.abort();
            }
        });

        loadConversations();
        fetchModels();
        if (!activeConversationId) startNewChat();
        else renderUI();
    });
    </script>
</body>
</html>